import sys

def hex_to_uart_vhdl(hex_string):
    """
    Convert a hex string to UART VHDL testbench code.
    Each byte is sent LSB first with start bit (0) and stop bit (1).
    Bytes are sent in the order they appear in the hex string (left to right).
    """
    vhdl_code = []
    
    # Remove any spaces or '0x' prefixes
    hex_string = hex_string.replace(" ", "").replace("0x", "")
    
    # Convert hex string to bytes (send in order they appear - left to right)
    bytes_list = []
    for i in range(0, len(hex_string), 2):
        if i + 1 < len(hex_string):
            byte_hex = hex_string[i:i+2]
            bytes_list.append(byte_hex)
    
    # Process each byte in order (first byte in string sent first)
    for byte_hex in bytes_list:
        byte_val = int(byte_hex, 16)
        # Convert to 8-bit binary string
        binary_str = format(byte_val, '08b')
        print(byte_hex)
        # Start bit
        vhdl_code.append("rx_data <= '0'; --start bit")
        vhdl_code.append("wait for bit_period;")
        vhdl_code.append("")
        
        # Data bits (LSB first - left to right in binary string)
        for bit_idx in range(8):
            bit_val = binary_str[7 - bit_idx]  # Access from right to left for LSB first
            print(f"D{bit_idx}: {bit_val}")
            vhdl_code.append(f"rx_data <= '{bit_val}'; -- data bit")
            vhdl_code.append("wait for bit_period;")
        
        # Stop bit
        vhdl_code.append("rx_data <= '1'; -- stop bit")
        vhdl_code.append("wait for bit_period;")
        vhdl_code.append("")
        
    
    return "\n".join(vhdl_code)


def generate_testbench(op_code, data_hex, output_file="src/tb_control_system.vhd"):
    """
    Generate a complete VHDL testbench file for UART XMSS accelerator.
    
    Args:
        op_code: 1 (key_gen), 2 (sign), or 3 (verify)
        data_hex: The hex string containing the operation data
        output_file: Output VHDL file path
    """
    
    # VHDL header
    header = """library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.STD_LOGIC_ARITH.ALL;
use IEEE.STD_LOGIC_UNSIGNED.ALL;

entity tb_accelerator_ethernet_axi_wrapper is
end tb_accelerator_ethernet_axi_wrapper;

architecture behavior of tb_accelerator_ethernet_axi_wrapper is

    -- Component Declaration for the Unit Under Test (UUT)
    component top
    Port (
        CLK100MHZ : in std_logic;
        sw0 : in std_logic;
        
        uart_rxd : in std_logic;
        uart_txd : out std_logic;
        
        led0_r   : out std_logic;
        led0_g   : out std_logic

        
    );
    end component;

    -- Signals for the testbench to drive the inputs to the UUT
    signal clk : std_logic := '0';
    signal rst : std_logic := '0';

    signal tx_data : std_logic := '0';
    signal rx_data : STD_LOGIC := '0';
    
    signal led_r : std_logic := '0';
    signal led_g : std_logic := '0';
    
    -- Clock period definition
    constant clk_period : time := 10 ns;
    constant bit_period : time := 8.6805us;

begin

    -- Instantiate the Unit Under Test (UUT)
    uut: top
    Port map (
        CLK100MHZ => clk,
        sw0 => rst,
        
        uart_txd => tx_data,
        uart_rxd => rx_data,
        
        led0_r => led_r,
        led0_g => led_g        
    );

    -- Clock process to generate clock signal
    clk_process :process
    begin
        clk <= '0';
        wait for clk_period/2;
        clk <= '1';
        wait for clk_period/2;
    end process;

    -- Stimulus process
    stim_proc: process
    begin
        -- Reset the UUT

        rst <= '0';
        wait for clk_period*20;
        rst <= '1';
        wait for clk_period*20;
        
        rx_data <= '1';
        wait for clk_period*10;
        
"""

    # VHDL footer
    footer = """
        wait;
    end process;

end behavior;
"""

    # Generate UART sequence from hex string
    uart_sequence = hex_to_uart_vhdl(data_hex)
    
    # Combine all parts
    full_testbench = header + uart_sequence + footer
    
    # Write to file
    with open(output_file, 'w') as f:
        f.write(full_testbench)
    
    print(f"Generated testbench for operation {op_code} at: {output_file}")
    print(f"Total bytes transmitted: {len(data_hex)//2}")


# Example usage with the three operation types:
if __name__ == "__main__":
    # Operation codes and their corresponding hex data
    
    # Key generation (op_code = 1)
    my_hex1 = "01111111111111111111111111111111111111111111111111111111111111111108000000"
    
    # Sign (op_code = 2)
    my_hex2 = "02111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000"
    
    # Verify (op_code = 3)
    my_hex3 = "0301000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
    
    # Operation map
    operations = {
        '1': (1, my_hex1, "key_gen"),
        '2': (2, my_hex2, "sign"),
        '3': (3, my_hex3, "verify")
    }
    
    # Check for command-line argument
    if len(sys.argv) > 1:
        op = sys.argv[1]
        if op in operations:
            op_code, hex_data, op_name = operations[op]
            generate_testbench(op_code, hex_data)
        else:
            print(f"Error: Invalid operation code '{op}'")
            print("Usage: python testbench_gen.py [1|2|3]")
            print("  1 = key_gen")
            print("  2 = sign")
            print("  3 = verify")
            sys.exit(1)
    else:
        print("Usage: python testbench_gen.py [1|2|3]")
        print("  1 = key_gen")
        print("  2 = sign")
        print("  3 = verify")
        sys.exit(1)